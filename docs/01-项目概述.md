# Modbus 电箱控制系统项目概述

## 1. 项目基本信息

- **项目名称**: Modbus 电箱控制系统
- **版本**: 3.4.2(3283)
- **主芯片**: 新唐科技 NANO100B 微控制器
- **当前版本**: v1.1.26 (20250328)
  - 主版本: 1
  - 子版本: 1
  - 修改版本: 25

## 2. 项目功能概述

这是一个基于 NANO100B 微控制器的电箱控制系统，主要用于冷冻冷藏设备的温湿度监控和控制。系统支持多种通信协议和传感器类型。

### 2.1 核心功能

- **温湿度监控**: 支持多种传感器类型(RS485、NTC、气调等)
- **Modbus 通信**: 支持多路 UART Modbus 通信(UART0-4)
- **LoRa 无线通信**: 支持 LoRa 网关和节点模式
- **历史数据记录**: 支持历史数据存储和查询
- **报警管理**: 多种报警类型处理
- **LCD 显示**: 实时信息显示
- **电压电流监控**: 电表集成和保护功能
- **远程控制**: 云端参数设置和状态监控

### 2.2 系统架构类型

系统支持多种配置模式，通过编译时宏定义选择：

1. **BL02D 模式**: 基础温湿度监控
2. **BL03D 模式**: 扩展功能版本，包含博怀版本和 Thermoberg 版本
3. **LoRa 网关模式**: 作为 LoRa 网关节点
4. **LoRa 节点模式**: 作为 LoRa 终端节点
5. **洪水监控模式**: 专用于洪水监控应用
6. **门磁监控模式**: 专用于门磁状态监控

## 3. 硬件平台

- **主控芯片**: 新唐科技 NANO100B 系列微控制器
- **通信接口**:
  - 5 路 UART (UART0-4)
  - LoRa 模块接口
  - RS485 接口
- **显示**: LCD 显示屏
- **存储**: 25Q128 Flash 存储芯片
- **传感器**: 支持多种温湿度传感器
- **电源管理**: 支持外部电源和电池供电，具备低功耗模式

## 4. 软件特性

- **实时操作**: 主循环架构，支持多任务处理
- **通信协议**: Modbus RTU、LoRa、MQTT
- **数据管理**: 历史数据存储、参数配置管理
- **故障保护**: 看门狗、电压电流保护、通信超时处理
- **用户界面**: LCD 显示、按键操作、触摸屏支持

## 5. 应用场景

- 冷链物流温湿度监控
- 冷库环境控制系统
- 工业环境监控
- 智能农业温室控制
- 医药冷藏设备监控

## 6. 开发环境要求

- **编译器**: ARM GCC 或 Keil MDK
- **开发板**: NANO100B 开发板
- **调试器**: 支持 SWD 接口的调试器
- **开发平台**: Windows/Mac/Linux

## 7. 文档结构

本项目文档包含以下部分：

1. 项目概述 (本文档)
2. 系统架构设计
3. 硬件接口说明
4. 软件模块详解
5. Modbus 协议实现
6. LoRa 通信实现
7. 数据存储和管理
8. 配置和参数管理
9. 错误处理和调试
10. 开发环境搭建
11. 编译和部署指南
12. API 参考手册
13. 移植和重构指南

## 8. 最新更新 (2025-03-28)

- 调整了化霜控制状态和系统强制开机的跟随问题
- 增加了温度值的随机变化功能
- 增加了复位功能 (watchdog 248 写入 78 执行复位)
- 增加了高低压和相序检测功能的开关控制 (变量 249)
- 屏蔽了断电信号处理

## 9. 项目重构建议

基于现有代码分析，建议重构时考虑：

1. **模块化重构**: 将功能拆分为独立模块
2. **配置系统优化**: 使用配置文件替代编译时宏定义
3. **通信层抽象**: 统一通信接口设计
4. **错误处理机制**: 建立统一的错误码和处理机制
5. **代码规范**: 统一命名规范和代码风格
6. **测试框架**: 建立单元测试和集成测试框架
