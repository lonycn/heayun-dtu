/**
 * ================================================================
 * 憨云 DTU - 主程序入口
 * ================================================================
 * 文件: main.c
 * 功能: 系统主程序，包含初始化和主循环
 * 目标: 新唐科技 NANO100B 微控制器
 * 作者: 憨云 DTU 开发团队
 * 日期: 2025-03-28
 * ================================================================
 */

#include "../../inc/nano100b_types.h"
#include "../../inc/nano100b_reg.h"
#include "../../inc/system.h"

// 移除printf声明，嵌入式系统不需要

// ================================================================
// 全局变量定义
// ================================================================

static volatile uint32_t g_main_loop_counter = 0; // 主循环计数器
static volatile bool g_system_running = false;    // 系统运行标志

// ================================================================
// 主程序入口
// ================================================================

/**
 * @brief 主程序入口函数
 * @return 程序退出码 (实际上不会返回)
 */
int main(void)
{
    // ================================================================
    // 1. 系统初始化
    // ================================================================

    // 系统硬件初始化 (包含启动效果：LED闪烁2次，蜂鸣器响2次)
    system_init();

    // 启动指示：LED和蜂鸣器各闪烁2次
    for (uint8_t i = 0; i < 2; i++)
    {
        led_set_status(TRUE);
        buzzer_beep(1, 100, 100);
        delay_ms(200);
        led_set_status(FALSE);
        delay_ms(200);
    }

    // OLED测试：显示HELLO
    oled_clear();
    delay_ms(100);
    oled_show_string(0, 0, "HELLO");
    oled_show_string(0, 2, "DTU SYSTEM");
    oled_show_string(0, 4, "READY");

    // 系统启动完成 (移除printf调用)

    // 设置系统运行标志
    g_system_running = true;

    // ================================================================
    // 2. 显示系统信息
    // ================================================================

    // 延时一段时间让用户看到启动信息
    delay_ms(1000);

    // 清屏并显示运行状态
    oled_clear();
    oled_show_string(0, 0, "HUA-COOL DTU");
    oled_show_string(0, 1, "Version: 1.0");
    oled_show_string(0, 2, "Status: OK");
    oled_show_string(0, 3, "Loop: 0");

    // ================================================================
    // 3. 主循环
    // ================================================================

    while (1)
    {
        // ================================================================
        // 主循环任务处理
        // ================================================================

        // 增加循环计数器
        g_main_loop_counter++;

        // ================================================================
        // 系统状态监控 (每1024次循环执行一次，使用位运算)
        // ================================================================

        if ((g_main_loop_counter & 0x3FF) == 0)
        { // 每1024次循环
            // 状态LED闪烁表示系统正常运行
            led_set_status(true);
            delay_ms(50);
            led_set_status(false);

            // 更新OLED显示
            if ((g_main_loop_counter & 0x3FFF) == 0)
            { // 每16384次循环更新显示
                oled_show_string(42, 3, "***");
            }
        }

        // ================================================================
        // 用户交互处理
        // ================================================================

        // 检查用户按键
        if (button_read_user())
        {
            // 按键按下：蜂鸣器响一声，调试LED亮
            buzzer_beep(1, 100, 0);
            led_set_debug(true);
            delay_ms(200);
            led_set_debug(false);

            // 等待按键释放
            while (button_read_user())
            {
                delay_ms(10);
            }
        }

        // ================================================================
        // 系统维护任务
        // ================================================================

        // 喂看门狗 (每128次循环，使用位运算)
        if ((g_main_loop_counter & 0x7F) == 0)
        { // 每128次循环
            watchdog_feed();
        }

        // ================================================================
        // 模拟传感器数据采集 (每512次循环，使用位运算)
        // ================================================================

        if ((g_main_loop_counter & 0x1FF) == 0)
        { // 每512次循环
            // 模拟温湿度数据采集
            // 实际项目中这里会调用传感器驱动函数

            // 更新OLED显示
            oled_show_string(0, 4, "Temp: 25.6C");
            oled_show_string(0, 5, "Humi: 60.0%");
        }

        // ================================================================
        // 模拟通信任务 (每2048次循环，使用位运算)
        // ================================================================

        if ((g_main_loop_counter & 0x7FF) == 0)
        { // 每2048次循环
            // 模拟LoRa通信
            // 实际项目中这里会调用LoRa驱动函数

            // 通信指示：调试LED快闪3次
            for (uint8_t i = 0; i < 3; i++)
            {
                led_set_debug(true);
                delay_ms(50);
                led_set_debug(false);
                delay_ms(50);
            }

            // 更新OLED显示
            oled_show_string(0, 6, "LoRa: TX OK");
        }

        // ================================================================
        // 错误检测和处理
        // ================================================================

        // 检查系统运行状态
        if (!g_system_running)
        {
            // 系统异常：蜂鸣器长响，LED常亮
            buzzer_control(true);
            led_set_status(true);
            led_set_debug(true);

            // 显示错误信息
            oled_clear();
            oled_show_string(0, 2, "SYSTEM ERROR");
            oled_show_string(0, 4, "RESET NEEDED");

            // 等待看门狗复位或手动复位
            while (1)
            {
                delay_ms(1000);
            }
        }

        // ================================================================
        // 循环延时控制
        // ================================================================

        // 主循环延时：控制循环频率约1kHz
        delay_ms(1);

        // 防止计数器溢出
        if (g_main_loop_counter >= 0xFFFFF000)
        {
            g_main_loop_counter = 0;
        }
    }

    // 程序不应该执行到这里
    return 0;
}